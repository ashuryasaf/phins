<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accountant Dashboard - PHINS Financial Reports</title>
    <link rel="stylesheet" href="/styles.css">
    <style>
        .dashboard-container { max-width: 1600px; margin: 0 auto; padding: 20px; }
        .header { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 30px; border-radius: 10px; margin-bottom: 30px; }
        .header h1 { margin: 0; }
        .header-nav { display: flex; gap: 15px; margin-top: 15px; flex-wrap: wrap; }
        .header-nav a { color: white; text-decoration: none; padding: 8px 16px; background: rgba(255,255,255,0.2); border-radius: 5px; }
        .header-nav a:hover { background: rgba(255,255,255,0.3); }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; border-radius: 10px; padding: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; }
        .stat-value { font-size: 2rem; font-weight: 700; color: #28a745; }
        .stat-value.negative { color: #dc3545; }
        .stat-value.warning { color: #ffc107; }
        .stat-label { color: #666; margin-top: 10px; font-size: 0.9rem; }
        
        .section { background: white; border-radius: 10px; padding: 25px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .section h2 { margin-top: 0; color: #333; border-bottom: 2px solid #28a745; padding-bottom: 10px; }
        
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab { padding: 10px 20px; border: none; background: #e9ecef; border-radius: 5px; cursor: pointer; font-weight: 600; }
        .tab.active { background: #28a745; color: white; }
        .tab:hover:not(.active) { background: #dee2e6; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e0e0e0; }
        th { background: #f8f9fa; font-weight: 600; }
        tr:hover { background: #f8f9fa; }
        
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { font-weight: 600; margin-bottom: 5px; color: #333; }
        .form-group input, .form-group select { padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 1rem; }
        
        .btn { padding: 12px 24px; border-radius: 5px; border: none; cursor: pointer; font-weight: 600; transition: all 0.3s; }
        .btn-primary { background: #28a745; color: white; }
        .btn-primary:hover { background: #218838; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #5a6268; }
        
        .chart-container { height: 300px; margin: 20px 0; background: #f8f9fa; border-radius: 8px; padding: 20px; }
        .bar-chart { display: flex; align-items: flex-end; height: 100%; gap: 10px; }
        .bar { background: linear-gradient(180deg, #28a745 0%, #20c997 100%); border-radius: 4px 4px 0 0; min-width: 40px; position: relative; }
        .bar-label { position: absolute; bottom: -25px; left: 50%; transform: translateX(-50%); font-size: 0.75rem; white-space: nowrap; }
        .bar-value { position: absolute; top: -25px; left: 50%; transform: translateX(-50%); font-size: 0.8rem; font-weight: 600; }
        
        .projection-table { max-height: 400px; overflow-y: auto; }
        .highlight-row { background: #e8f5e9 !important; }
        
        .integrity-status { padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .integrity-healthy { background: #d4edda; color: #155724; }
        .integrity-issues { background: #f8d7da; color: #721c24; }
        .integrity-warnings { background: #fff3cd; color: #856404; }
        
        .lump-sum-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .lump-sum-card { background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #28a745; }
        .lump-sum-card h4 { margin: 0 0 10px 0; color: #333; }
        .lump-sum-value { font-size: 1.5rem; font-weight: 700; color: #28a745; }
        
        .loading { text-align: center; padding: 40px; color: #666; }
        .error { background: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="header">
            <h1>üí∞ Accountant Dashboard - Financial Reports</h1>
            <p>Long-term financial projections, actuarial analysis, and data integrity validation</p>
            <div class="header-nav">
                <a href="/admin.html">Admin Dashboard</a>
                <a href="/admin-portal.html">Admin Portal</a>
                <a href="/billing.html">Billing</a>
                <a href="/dashboard.html">Customer Portal</a>
                <a href="/login.html">Logout</a>
            </div>
        </div>
        
        <!-- Quick Stats -->
        <div class="stats-grid" id="quick-stats">
            <div class="stat-card">
                <div class="stat-value" id="total-revenue">$0</div>
                <div class="stat-label">Total Revenue (Annual)</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-collected">$0</div>
                <div class="stat-label">Collected</div>
            </div>
            <div class="stat-card">
                <div class="stat-value warning" id="outstanding-ar">$0</div>
                <div class="stat-label">Outstanding A/R</div>
            </div>
            <div class="stat-card">
                <div class="stat-value negative" id="claims-liability">$0</div>
                <div class="stat-label">Claims Liability</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="loss-ratio">0%</div>
                <div class="stat-label">Loss Ratio</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="solvency-ratio">0</div>
                <div class="stat-label">Solvency Ratio</div>
            </div>
        </div>
        
        <!-- Main Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('projection')">üìä Customer Projection</button>
            <button class="tab" onclick="showTab('forecast')">üìà 25-Year Forecast</button>
            <button class="tab" onclick="showTab('portfolio')">üìã Portfolio Report</button>
            <button class="tab" onclick="showTab('integrity')">‚úÖ Data Integrity</button>
            <button class="tab" onclick="showTab('dashboards')">üëÅÔ∏è Dashboard Views</button>
        </div>
        
        <!-- Customer Projection Tab -->
        <div id="projection-tab" class="tab-content active">
            <div class="section">
                <h2>Long-Term Customer Projection Calculator</h2>
                <p>Calculate actuarially-sound premiums and projections based on coverage, savings, ADL level, and term.</p>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Coverage Amount ($)</label>
                        <input type="number" id="proj-coverage" value="250000" min="10000" step="10000">
                    </div>
                    <div class="form-group">
                        <label>Savings Allocation (%)</label>
                        <input type="number" id="proj-savings" value="50" min="0" max="100" step="5">
                    </div>
                    <div class="form-group">
                        <label>ADL Level (1-10)</label>
                        <select id="proj-adl">
                            <option value="1">1 - Fully Independent</option>
                            <option value="2">2 - Independent w/ Supervision</option>
                            <option value="3">3 - Minimal Assistance</option>
                            <option value="4">4 - Moderate Assistance</option>
                            <option value="5" selected>5 - Significant Assistance (Medium)</option>
                            <option value="6">6 - Extensive Assistance</option>
                            <option value="7">7 - Maximum Assistance</option>
                            <option value="8">8 - Total Dependence (Some)</option>
                            <option value="9">9 - Total Dependence (Most)</option>
                            <option value="10">10 - Complete Dependence</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Term (Years)</label>
                        <input type="number" id="proj-term" value="25" min="5" max="40" step="5">
                    </div>
                    <div class="form-group">
                        <label>Customer Age</label>
                        <input type="number" id="proj-age" value="35" min="18" max="75">
                    </div>
                </div>
                
                <button class="btn btn-primary" onclick="calculateProjection()">Calculate Projection</button>
                
                <div id="projection-results" style="margin-top: 30px;"></div>
            </div>
        </div>
        
        <!-- 25-Year Forecast Tab -->
        <div id="forecast-tab" class="tab-content">
            <div class="section">
                <h2>25-Year Portfolio Forecast</h2>
                <p>Long-term revenue, claims, and profitability projections for the entire portfolio.</p>
                
                <div class="form-row" style="max-width: 400px;">
                    <div class="form-group">
                        <label>Forecast Years</label>
                        <input type="number" id="forecast-years" value="25" min="5" max="50" step="5">
                    </div>
                    <div class="form-group" style="justify-content: flex-end;">
                        <button class="btn btn-primary" onclick="loadForecast()">Generate Forecast</button>
                    </div>
                </div>
                
                <div id="forecast-results"></div>
            </div>
        </div>
        
        <!-- Portfolio Report Tab -->
        <div id="portfolio-tab" class="tab-content">
            <div class="section">
                <h2>Portfolio Summary Report</h2>
                <button class="btn btn-primary" onclick="loadPortfolioReport()" style="margin-bottom: 20px;">Refresh Report</button>
                <div id="portfolio-results"><div class="loading">Loading portfolio report...</div></div>
            </div>
        </div>
        
        <!-- Data Integrity Tab -->
        <div id="integrity-tab" class="tab-content">
            <div class="section">
                <h2>Data Integrity Validation</h2>
                <p>Bottom-up validation of all data across policies, billing, claims, and underwriting.</p>
                <button class="btn btn-primary" onclick="loadIntegrityReport()" style="margin-bottom: 20px;">Run Validation</button>
                <div id="integrity-results"><div class="loading">Click "Run Validation" to check data integrity...</div></div>
            </div>
        </div>
        
        <!-- Dashboard Views Tab -->
        <div id="dashboards-tab" class="tab-content">
            <div class="section">
                <h2>Cross-Dashboard Data View</h2>
                <p>View data summaries from all dashboards for reconciliation.</p>
                
                <div class="tabs" style="margin-top: 20px;">
                    <button class="tab active" onclick="loadDashboardView('accountant')">Accountant</button>
                    <button class="tab" onclick="loadDashboardView('underwriter')">Underwriter</button>
                    <button class="tab" onclick="loadDashboardView('claims')">Claims</button>
                    <button class="tab" onclick="loadDashboardView('admin')">Admin</button>
                </div>
                
                <div id="dashboard-view-results" style="margin-top: 20px;"></div>
            </div>
        </div>
    </div>
    
    <script>
        const token = localStorage.getItem('phins_token');
        if (!token) window.location.href = '/login.html';
        
        // Tab management
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tabs .tab').forEach(t => t.classList.remove('active'));
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
        }
        
        // Format currency
        function formatCurrency(amount) {
            return '$' + Number(amount || 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }
        
        // Load quick stats
        async function loadQuickStats() {
            try {
                const response = await fetch('/api/financial/dashboard-summary?type=accountant', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                
                document.getElementById('total-revenue').textContent = formatCurrency(data.total_revenue);
                document.getElementById('total-collected').textContent = formatCurrency(data.total_collected);
                document.getElementById('outstanding-ar').textContent = formatCurrency(data.outstanding_ar);
                document.getElementById('claims-liability').textContent = formatCurrency(data.claims_pending);
                
                const lossRatio = data.total_collected > 0 
                    ? ((data.claims_paid || 0) / data.total_collected * 100).toFixed(1) 
                    : '0';
                document.getElementById('loss-ratio').textContent = lossRatio + '%';
                
                // Load portfolio for solvency
                const portfolioResp = await fetch('/api/financial/portfolio-report', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const portfolio = await portfolioResp.json();
                document.getElementById('solvency-ratio').textContent = 
                    (portfolio.summary?.solvency_ratio || 0).toFixed(2);
            } catch (err) {
                console.error('Error loading stats:', err);
            }
        }
        
        // Calculate customer projection
        async function calculateProjection() {
            const coverage = document.getElementById('proj-coverage').value;
            const savingsPct = document.getElementById('proj-savings').value / 100;
            const adlLevel = document.getElementById('proj-adl').value;
            const termYears = document.getElementById('proj-term').value;
            const age = document.getElementById('proj-age').value;
            
            const resultsDiv = document.getElementById('projection-results');
            resultsDiv.innerHTML = '<div class="loading">Calculating projection...</div>';
            
            try {
                const response = await fetch(
                    `/api/financial/customer-projection?coverage=${coverage}&savings_pct=${savingsPct}&adl_level=${adlLevel}&term_years=${termYears}&age=${age}`,
                    { headers: { 'Authorization': `Bearer ${token}` } }
                );
                const data = await response.json();
                
                if (data.error) {
                    resultsDiv.innerHTML = `<div class="error">${data.error}</div>`;
                    return;
                }
                
                // Render results
                let html = `
                    <h3>Premium Breakdown</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${formatCurrency(data.premium_breakdown.annual_premium)}</div>
                            <div class="stat-label">Annual Premium</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${formatCurrency(data.premium_breakdown.monthly_premium)}</div>
                            <div class="stat-label">Monthly Premium</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${formatCurrency(data.premium_breakdown.risk_component)}</div>
                            <div class="stat-label">Risk Component</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${formatCurrency(data.premium_breakdown.savings_component)}</div>
                            <div class="stat-label">Savings Component</div>
                        </div>
                    </div>
                    
                    <h3>Lump Sum Benefit Options</h3>
                    <div class="lump-sum-grid">
                        <div class="lump-sum-card">
                            <h4>Death Benefit</h4>
                            <div class="lump-sum-value">${formatCurrency(data.lump_sum_options.death_benefit_lump_sum)}</div>
                        </div>
                        <div class="lump-sum-card">
                            <h4>Terminal Illness (90%)</h4>
                            <div class="lump-sum-value">${formatCurrency(data.lump_sum_options.terminal_illness_lump_sum)}</div>
                        </div>
                        <div class="lump-sum-card">
                            <h4>ADL Claim Benefit</h4>
                            <div class="lump-sum-value">${formatCurrency(data.lump_sum_options.adl_claim_lump_sum)}</div>
                        </div>
                        <div class="lump-sum-card">
                            <h4>Surrender Value</h4>
                            <div class="lump-sum-value">${formatCurrency(data.lump_sum_options.surrender_value)}</div>
                        </div>
                        <div class="lump-sum-card">
                            <h4>Maturity Value</h4>
                            <div class="lump-sum-value">${formatCurrency(data.lump_sum_options.maturity_value)}</div>
                        </div>
                        <div class="lump-sum-card">
                            <h4>Annuity (20-Year)</h4>
                            <div class="lump-sum-value">${formatCurrency(data.lump_sum_options.annuity_conversion['20_year'])}/mo</div>
                        </div>
                    </div>
                    
                    <h3>Key Milestones</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Year</th>
                                <th>Age</th>
                                <th>Premiums Paid</th>
                                <th>Savings Fund</th>
                                <th>Cash Value</th>
                                <th>Death Benefit</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                const milestones = [5, 10, 15, 20, 25];
                milestones.forEach(year => {
                    const m = data.key_milestones[`year_${year}`];
                    if (m) {
                        html += `
                            <tr class="highlight-row">
                                <td><strong>Year ${m.year}</strong></td>
                                <td>${m.age}</td>
                                <td>${formatCurrency(m.cumulative_premiums)}</td>
                                <td>${formatCurrency(m.savings_fund_balance)}</td>
                                <td>${formatCurrency(m.total_cash_value)}</td>
                                <td>${formatCurrency(m.death_benefit)}</td>
                            </tr>
                        `;
                    }
                });
                
                html += `</tbody></table>
                    
                    <h3>Full Year-by-Year Projection</h3>
                    <div class="projection-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Year</th>
                                    <th>Age</th>
                                    <th>Premiums Paid</th>
                                    <th>Risk Fund</th>
                                    <th>Savings Fund</th>
                                    <th>Cash Value</th>
                                    <th>Death Benefit</th>
                                    <th>ADL Benefit</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                data.yearly_projections.forEach(p => {
                    html += `
                        <tr>
                            <td>${p.year}</td>
                            <td>${p.age}</td>
                            <td>${formatCurrency(p.cumulative_premiums)}</td>
                            <td>${formatCurrency(p.risk_fund_balance)}</td>
                            <td>${formatCurrency(p.savings_fund_balance)}</td>
                            <td>${formatCurrency(p.total_cash_value)}</td>
                            <td>${formatCurrency(p.death_benefit)}</td>
                            <td>${formatCurrency(p.adl_claim_benefit)}</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div>';
                
                resultsDiv.innerHTML = html;
            } catch (err) {
                resultsDiv.innerHTML = `<div class="error">Error: ${err.message}</div>`;
            }
        }
        
        // Load 25-year forecast
        async function loadForecast() {
            const years = document.getElementById('forecast-years').value;
            const resultsDiv = document.getElementById('forecast-results');
            resultsDiv.innerHTML = '<div class="loading">Generating forecast...</div>';
            
            try {
                const response = await fetch(`/api/financial/forecast?years=${years}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                
                if (data.error) {
                    resultsDiv.innerHTML = `<div class="error">${data.error}</div>`;
                    return;
                }
                
                let html = `
                    <h3>Forecast Assumptions</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${data.assumptions.new_policy_growth_rate}</div>
                            <div class="stat-label">Annual Growth Rate</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${data.assumptions.premium_inflation_rate}</div>
                            <div class="stat-label">Premium Inflation</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${data.assumptions.claim_rate}</div>
                            <div class="stat-label">Annual Claim Rate</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${formatCurrency(data.assumptions.avg_claim_amount)}</div>
                            <div class="stat-label">Avg Claim Amount</div>
                        </div>
                    </div>
                    
                    <h3>Year ${years} Summary</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${data.summary.year_25_policies.toLocaleString()}</div>
                            <div class="stat-label">Projected Policies</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${formatCurrency(data.summary.year_25_revenue)}</div>
                            <div class="stat-label">Cumulative Revenue</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${formatCurrency(data.summary.year_25_profit)}</div>
                            <div class="stat-label">Cumulative Profit</div>
                        </div>
                    </div>
                    
                    <h3>Year-by-Year Projections</h3>
                    <div class="projection-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Year</th>
                                    <th>Date</th>
                                    <th>Active Policies</th>
                                    <th>Annual Revenue</th>
                                    <th>Expected Claims</th>
                                    <th>Net Income</th>
                                    <th>Cumulative Profit</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                data.projections.forEach(p => {
                    const highlight = [5, 10, 15, 20, 25].includes(p.year) ? 'class="highlight-row"' : '';
                    html += `
                        <tr ${highlight}>
                            <td>${p.year}</td>
                            <td>${p.projected_date}</td>
                            <td>${p.active_policies.toLocaleString()}</td>
                            <td>${formatCurrency(p.annual_premium_revenue)}</td>
                            <td>${formatCurrency(p.expected_claims)}</td>
                            <td>${formatCurrency(p.net_income)}</td>
                            <td>${formatCurrency(p.cumulative_profit)}</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div>';
                resultsDiv.innerHTML = html;
            } catch (err) {
                resultsDiv.innerHTML = `<div class="error">Error: ${err.message}</div>`;
            }
        }
        
        // Load portfolio report
        async function loadPortfolioReport() {
            const resultsDiv = document.getElementById('portfolio-results');
            resultsDiv.innerHTML = '<div class="loading">Loading portfolio report...</div>';
            
            try {
                const response = await fetch('/api/financial/portfolio-report', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                
                if (data.error) {
                    resultsDiv.innerHTML = `<div class="error">${data.error}</div>`;
                    return;
                }
                
                let html = `
                    <h3>Portfolio Summary</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${data.summary.total_policies}</div>
                            <div class="stat-label">Active Policies</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${formatCurrency(data.summary.total_coverage)}</div>
                            <div class="stat-label">Total Coverage</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${formatCurrency(data.summary.total_annual_premiums)}</div>
                            <div class="stat-label">Annual Premiums</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${formatCurrency(data.summary.total_claims_liability)}</div>
                            <div class="stat-label">Claims Liability</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${formatCurrency(data.summary.reserve_requirement)}</div>
                            <div class="stat-label">Reserve Requirement</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${data.summary.solvency_ratio.toFixed(2)}</div>
                            <div class="stat-label">Solvency Ratio</div>
                        </div>
                    </div>
                    
                    <h3>Risk Distribution</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${data.risk_distribution.low || 0}</div>
                            <div class="stat-label">Low Risk</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${data.risk_distribution.medium || 0}</div>
                            <div class="stat-label">Medium Risk</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${data.risk_distribution.high || 0}</div>
                            <div class="stat-label">High Risk</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${data.risk_distribution.very_high || 0}</div>
                            <div class="stat-label">Very High Risk</div>
                        </div>
                    </div>
                    
                    <h3>Coverage by Type</h3>
                    <table>
                        <thead><tr><th>Policy Type</th><th>Total Coverage</th></tr></thead>
                        <tbody>
                `;
                
                Object.entries(data.coverage_by_type || {}).forEach(([type, coverage]) => {
                    html += `<tr><td>${type}</td><td>${formatCurrency(coverage)}</td></tr>`;
                });
                
                html += `</tbody></table>
                    
                    <h3>Age Distribution</h3>
                    <table>
                        <thead><tr><th>Age Range</th><th>Count</th></tr></thead>
                        <tbody>
                `;
                
                Object.entries(data.age_distribution || {}).forEach(([range, count]) => {
                    html += `<tr><td>${range}</td><td>${count}</td></tr>`;
                });
                
                html += `</tbody></table>
                    <p style="color: #666; margin-top: 20px;">Generated at: ${data.generated_at}</p>
                `;
                
                resultsDiv.innerHTML = html;
            } catch (err) {
                resultsDiv.innerHTML = `<div class="error">Error: ${err.message}</div>`;
            }
        }
        
        // Load data integrity report
        async function loadIntegrityReport() {
            const resultsDiv = document.getElementById('integrity-results');
            resultsDiv.innerHTML = '<div class="loading">Running validation...</div>';
            
            try {
                const response = await fetch('/api/financial/data-integrity', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                
                if (data.error) {
                    resultsDiv.innerHTML = `<div class="error">${data.error}</div>`;
                    return;
                }
                
                const statusClass = data.status === 'healthy' ? 'integrity-healthy' : 
                    data.issues_count > 0 ? 'integrity-issues' : 'integrity-warnings';
                
                let html = `
                    <div class="integrity-status ${statusClass}">
                        <h3 style="margin: 0;">Status: ${data.status.toUpperCase()}</h3>
                        <p style="margin: 5px 0 0 0;">${data.issues_count} issues, ${data.warnings_count} warnings</p>
                    </div>
                    
                    <h3>Data Counts</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${data.data_counts.policies}</div>
                            <div class="stat-label">Total Policies</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${data.data_counts.active_policies}</div>
                            <div class="stat-label">Active Policies</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${data.data_counts.customers}</div>
                            <div class="stat-label">Customers</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${data.data_counts.claims}</div>
                            <div class="stat-label">Claims</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${data.data_counts.billing_records}</div>
                            <div class="stat-label">Billing Records</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${data.data_counts.underwriting_apps}</div>
                            <div class="stat-label">Underwriting Apps</div>
                        </div>
                    </div>
                    
                    <h3>Financial Reconciliation</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${formatCurrency(data.financial_reconciliation.total_expected_premiums)}</div>
                            <div class="stat-label">Expected Premiums</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${formatCurrency(data.financial_reconciliation.total_billed)}</div>
                            <div class="stat-label">Total Billed</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${formatCurrency(data.financial_reconciliation.total_collected)}</div>
                            <div class="stat-label">Total Collected</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${data.financial_reconciliation.collection_rate}%</div>
                            <div class="stat-label">Collection Rate</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${formatCurrency(data.financial_reconciliation.total_claims_approved)}</div>
                            <div class="stat-label">Claims Approved</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${data.financial_reconciliation.loss_ratio}%</div>
                            <div class="stat-label">Loss Ratio</div>
                        </div>
                    </div>
                `;
                
                if (data.issues.length > 0) {
                    html += `<h3>Issues (${data.issues_count})</h3><ul style="color: #721c24;">`;
                    data.issues.forEach(issue => {
                        html += `<li>${issue}</li>`;
                    });
                    html += '</ul>';
                }
                
                if (data.warnings.length > 0) {
                    html += `<h3>Warnings (${data.warnings_count})</h3><ul style="color: #856404;">`;
                    data.warnings.forEach(warning => {
                        html += `<li>${warning}</li>`;
                    });
                    html += '</ul>';
                }
                
                html += `<p style="color: #666; margin-top: 20px;">Validated at: ${data.validated_at}</p>`;
                
                resultsDiv.innerHTML = html;
            } catch (err) {
                resultsDiv.innerHTML = `<div class="error">Error: ${err.message}</div>`;
            }
        }
        
        // Load dashboard view
        async function loadDashboardView(type) {
            // Update active tab
            document.querySelectorAll('#dashboards-tab .tabs .tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            const resultsDiv = document.getElementById('dashboard-view-results');
            resultsDiv.innerHTML = '<div class="loading">Loading dashboard data...</div>';
            
            try {
                const response = await fetch(`/api/financial/dashboard-summary?type=${type}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                
                if (data.error) {
                    resultsDiv.innerHTML = `<div class="error">${data.error}</div>`;
                    return;
                }
                
                let html = `<h3>${type.charAt(0).toUpperCase() + type.slice(1)} Dashboard Data</h3>
                    <table>
                        <thead><tr><th>Metric</th><th>Value</th></tr></thead>
                        <tbody>
                `;
                
                Object.entries(data).forEach(([key, value]) => {
                    if (key !== 'generated_at') {
                        const displayKey = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                        const displayValue = typeof value === 'number' && key.includes('revenue') || key.includes('collected') || key.includes('ar') || key.includes('claims') || key.includes('liability') || key.includes('pending')
                            ? formatCurrency(value)
                            : typeof value === 'object' ? JSON.stringify(value, null, 2) : value;
                        html += `<tr><td>${displayKey}</td><td>${displayValue}</td></tr>`;
                    }
                });
                
                html += `</tbody></table>
                    <p style="color: #666; margin-top: 20px;">Generated at: ${data.generated_at}</p>
                `;
                
                resultsDiv.innerHTML = html;
            } catch (err) {
                resultsDiv.innerHTML = `<div class="error">Error: ${err.message}</div>`;
            }
        }
        
        // Initial load
        loadQuickStats();
        loadPortfolioReport();
        
        // Auto-refresh
        setInterval(loadQuickStats, 60000);
    </script>
</body>
</html>
