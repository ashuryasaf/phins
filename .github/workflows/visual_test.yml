name: Visual PDF test

on:
  push:
    branches: [ main ]
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  generate-and-upload:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install system deps (poppler for pdf2image)
        run: |
          sudo apt-get update
          sudo apt-get install -y poppler-utils || true

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt -r requirements-dev.txt

      - name: Generate PDF
        run: |
          python generate_client_pdf.py --customer CI_TEST --output ci_report.pdf --no-demo

      - name: Convert first page to PNG
        run: |
          python -c 'from pdf2image import convert_from_path; imgs = convert_from_path("ci_report.pdf", first_page=1, last_page=1); imgs[0].save("ci_report_page1.png")'
        continue-on-error: true

      - name: Upload to S3 (presigned URL)
        env:
          AWS_REGION: ${{ secrets.AWS_REGION }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          S3_BUCKET: ${{ secrets.VISUAL_TEST_BUCKET }}
        run: |
          python visual_upload.py ci_report.pdf ${{ secrets.VISUAL_TEST_BUCKET }} ci_reports/ci_report.pdf
        continue-on-error: true
